<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>stviz Documentation</title>
  <style>
    :root {
      --bg: #f6f1ea;
      --bg-2: #e7f0ee;
      --ink: #1f2421;
      --muted: #56605f;
      --accent: #1f4f5a;
      --accent-2: #d76b3c;
      --accent-3: #6b7d2a;
      --card: #fffaf3;
      --line: #d7cfc2;
      --shadow: 0 24px 60px rgba(31, 36, 33, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at 15% -10%, rgba(215, 107, 60, 0.12), transparent 60%),
        radial-gradient(1000px 600px at 85% 0%, rgba(31, 79, 90, 0.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg-2));
      font-family: "Space Grotesk", "Sora", "IBM Plex Sans", "Noto Sans", sans-serif;
      line-height: 1.55;
    }

    header {
      padding: 72px 24px 24px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
    }

    .hero {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 24px;
      padding: 32px 36px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: -40% 65% auto -30%;
      height: 220px;
      background: radial-gradient(200px 140px at center, rgba(31, 79, 90, 0.18), transparent 70%);
      opacity: 0.7;
      pointer-events: none;
    }

    h1 {
      font-family: "Fraunces", "Spectral", "Playfair Display", serif;
      font-size: clamp(2.3rem, 3.4vw, 3.4rem);
      margin: 0 0 8px;
      letter-spacing: 0.5px;
    }

    h2 {
      font-family: "Fraunces", "Spectral", "Playfair Display", serif;
      margin: 32px 0 12px;
      font-size: clamp(1.6rem, 2.3vw, 2.1rem);
    }

    h3 {
      margin: 24px 0 8px;
      font-size: 1.1rem;
    }

    p {
      margin: 0 0 12px;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .pill {
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fef7ef;
      font-size: 0.9rem;
    }

    main {
      padding: 12px 24px 80px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 18px 18px 14px;
      box-shadow: 0 12px 28px rgba(31, 36, 33, 0.08);
    }

    .toc {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc li {
      padding: 10px 14px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fffdf8;
    }

    .note {
      border-left: 4px solid var(--accent-2);
      background: #fff4e9;
      padding: 12px 16px;
      margin: 14px 0;
      border-radius: 12px;
    }

    code, pre {
      font-family: "JetBrains Mono", "Fira Code", "Menlo", "Consolas", monospace;
      font-size: 0.92rem;
    }

    pre {
      background: #1c2221;
      color: #f6f2eb;
      padding: 16px;
      border-radius: 14px;
      overflow-x: auto;
    }

    .shot {
      border: 2px dashed #a9b3a8;
      border-radius: 16px;
      padding: 24px;
      background: linear-gradient(135deg, rgba(31, 79, 90, 0.08), rgba(215, 107, 60, 0.08));
      min-height: 180px;
      display: grid;
      place-items: center;
      font-weight: 600;
      color: #3b4741;
      text-align: center;
      letter-spacing: 0.4px;
    }

    .shot::before {
      content: attr(data-label);
    }

    .split {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    footer {
      padding: 24px;
      border-top: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.5);
      text-align: center;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      header {
        padding-top: 48px;
      }
      .hero {
        padding: 24px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap hero">
      <h1>stviz Documentation</h1>
      <p>GPU-accelerated viewer for large single-cell and spatial transcriptomics point clouds. This document explains how the system works end to end, how the file format is structured, and how to operate the viewer in production workflows.</p>
      <div class="meta">
        <div class="pill">Rust + egui/wgpu renderer</div>
        <div class="pill">Python exporter for .h5ad to .stviz</div>
        <div class="pill">Zero-copy memory mapping</div>
        <div class="pill">Timeline-based transitions</div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <section class="card">
        <h2>Table of contents</h2>
        <ul class="toc">
          <li><a href="#overview">Overview</a></li>
          <li><a href="#layout">Repository layout</a></li>
          <li><a href="#build">Build and run</a></li>
          <li><a href="#convert">Data conversion pipeline</a></li>
          <li><a href="#format">.stviz file format</a></li>
          <li><a href="#architecture">Architecture and data flow</a></li>
          <li><a href="#ui">Viewer UI guide</a></li>
          <li><a href="#timeline">Timeline and transitions</a></li>
          <li><a href="#colors">Colors, filters, and gene mode</a></li>
          <li><a href="#grid">Sample grid layout</a></li>
          <li><a href="#export">Screenshots, recording, export</a></li>
          <li><a href="#performance">Performance tuning</a></li>
          <li><a href="#troubleshooting">Troubleshooting</a></li>
          <li><a href="#extend">Extending stviz</a></li>
        </ul>
      </section>

      <section id="overview">
        <h2>Overview</h2>
        <div class="split">
          <div>
            <p>stviz renders large point clouds on the GPU and transitions the same cells between multiple 2D coordinate spaces (spatial, UMAP, tSNE, PCA, and more). It is optimized for fast, interactive exploration and for creating exported videos or frame sequences that show continuous transitions.</p>
            <p>The core workflow is:</p>
            <ol>
              <li>Export .h5ad datasets to the compact .stviz binary format.</li>
              <li>Open the .stviz file in the viewer.</li>
              <li>Configure transitions, colors, and filters.</li>
              <li>Capture screenshots or export videos.</li>
            </ol>
          </div>
          <div class="shot" data-label="Screenshot placeholder: stviz main view with left panel, timeline, and viewport"></div>
        </div>
      </section>

      <section id="layout">
        <h2>Repository layout</h2>
        <div class="grid">
          <div class="card">
            <h3>Rust viewer</h3>
            <p><code>src/app.rs</code> - UI and interaction logic</p>
            <p><code>src/render.rs</code> - GPU pipeline and buffer uploads</p>
            <p><code>src/data.rs</code> - .stviz parsing and memory mapping</p>
            <p><code>src/camera.rs</code> - pan/zoom camera</p>
            <p><code>src/color.rs</code> - palettes and gradients</p>
          </div>
          <div class="card">
            <h3>Assets</h3>
            <p><code>assets/pointcloud.wgsl</code> - point sprite shader, blending, transition interpolation</p>
          </div>
          <div class="card">
            <h3>Python tools</h3>
            <p><code>python/export_stviz.py</code> - exporter from .h5ad to .stviz</p>
            <p><code>python/mock_spatial_dataset.py</code> - optional mock dataset generator</p>
          </div>
          <div class="card">
            <h3>Data and output</h3>
            <p><code>data/</code> - sample .h5ad and .stviz files</p>
            <p><code>output/</code> - screenshots, recording frames, export videos</p>
          </div>
        </div>
      </section>

      <section id="build">
        <h2>Build and run</h2>
        <div class="split">
          <div class="card">
            <h3>Windows</h3>
            <p>Install Rust stable and Visual Studio Build Tools.</p>
            <pre><code>cargo run --release</code></pre>
          </div>
          <div class="card">
            <h3>Linux (Ubuntu or Debian)</h3>
            <p>Install Rust and GTK dev libraries (required for file dialogs).</p>
            <pre><code>sudo apt-get update
sudo apt-get install -y libgtk-3-dev
cargo run --release</code></pre>
          </div>
        </div>
        <div class="note">
          The viewer uses the wgpu backend through eframe. GPU support is required for large datasets.
        </div>
      </section>

      <section id="convert">
        <h2>Data conversion pipeline</h2>
        <p>The viewer consumes a binary .stviz file. Use the exporter to convert .h5ad datasets.</p>
        <pre><code>python -m pip install -U anndata h5py numpy pandas scipy
python python/export_stviz.py --input your_data.h5ad --output your_data.stviz</code></pre>
        <p>Optional: include expression matrix for gene coloring (larger files, more memory).</p>
        <pre><code>python python/export_stviz.py --input your_data.h5ad --output your_data.stviz --include-expr</code></pre>
        <div class="note">
          If no 2D spaces exist in <code>.obsm</code>, the exporter looks for obs column pairs like <code>x/y</code>, <code>spatial_x/spatial_y</code>, or <code>centroid_x/centroid_y</code>.
        </div>
      </section>

      <section id="format">
        <h2>.stviz file format</h2>
        <p>The format is a single binary file optimized for fast memory mapping.</p>
        <pre><code>[u64 json_len]
[json bytes]
[padding to 16-byte boundary]
[raw binary blocks]</code></pre>
        <h3>JSON metadata</h3>
        <ul>
          <li><strong>version</strong> - format version (currently 1)</li>
          <li><strong>n_points</strong> - number of cells</li>
          <li><strong>spaces</strong> - list of 2D coordinate spaces with byte offsets, lengths, and bounding boxes</li>
          <li><strong>obs</strong> - categorical or continuous per-cell fields</li>
          <li><strong>expr</strong> - optional CSC matrix for gene coloring</li>
        </ul>
        <h3>Alignment and offsets</h3>
        <ul>
          <li>Exporter aligns data blocks to 4 bytes.</li>
          <li>Viewer aligns JSON to 16 bytes and memory maps the file.</li>
          <li>Offsets in the JSON are relative to the data section, not the file start.</li>
        </ul>
      </section>

      <section id="architecture">
        <h2>Architecture and data flow</h2>
        <div class="split">
          <div>
            <h3>High-level flow</h3>
            <ol>
              <li>Load .stviz into memory map (<code>src/data.rs</code>).</li>
              <li>Select spaces, colors, and filters in UI (<code>src/app.rs</code>).</li>
              <li>Upload buffers to GPU when inputs change (<code>src/render.rs</code>).</li>
              <li>Shader interpolates positions and colors based on timeline (<code>assets/pointcloud.wgsl</code>).</li>
            </ol>
          </div>
          <div class="card">
            <h3>Zero-copy philosophy</h3>
            <p>Spaces and obs arrays are mapped directly into memory. GPU buffers are updated only when IDs change, and uniform data is updated each frame.</p>
          </div>
        </div>
        <div class="shot" data-label="Screenshot placeholder: architecture diagram or data flow">
        </div>
      </section>

      <section id="ui">
        <h2>Viewer UI guide</h2>
        <div class="split">
          <div>
            <h3>Navigation</h3>
            <ul>
              <li>Mouse drag - pan</li>
              <li>Mouse wheel - zoom</li>
              <li>Spacebar - play or pause timeline</li>
              <li>Arrow keys - step timeline</li>
            </ul>
            <h3>Left panel sections</h3>
            <ul>
              <li>Convert .h5ad - drop file or choose a file dialog</li>
              <li>Open .stviz - open with file dialog or path entry</li>
              <li>View - themes, background, axis overlay, normalize spaces</li>
              <li>Sample grid - tile samples into a grid layout</li>
              <li>Color - categorical, continuous, and gene mode</li>
              <li>Rendering - point radius, downsample, fast render</li>
              <li>Output - screenshot, recording, export video loop</li>
            </ul>
          </div>
          <div class="shot" data-label="Screenshot placeholder: left panel detail with settings">
          </div>
        </div>
      </section>

      <section id="timeline">
        <h2>Timeline and transitions</h2>
        <p>The bottom timeline controls transitions between spaces. Each keyframe stores a space selection and an optional color key.</p>
        <ul>
          <li><strong>Single mode</strong> - only the first and last keyframes are used.</li>
          <li><strong>Path mode</strong> - multi-step transitions across spaces.</li>
          <li><strong>Key times</strong> - drag key markers to change segment durations.</li>
          <li><strong>Easing</strong> - linear, smoothstep, sine in-out, quad in-out.</li>
        </ul>
        <div class="split">
          <div class="shot" data-label="Screenshot placeholder: timeline with keyframes"></div>
          <div class="card">
            <h3>Export-aware playback</h3>
            <p>During export, the timeline advances deterministically based on FPS and playback mode. The export camera can auto-fit across all used spaces for stable framing.</p>
          </div>
        </div>
      </section>

      <section id="colors">
        <h2>Colors, filters, and gene mode</h2>
        <div class="grid">
          <div class="card">
            <h3>Categorical</h3>
            <p>Uses the .obs categorical field. Optional palettes from <code>adata.uns["&lt;col&gt;_colors"]</code> are supported. Filters allow per-category inclusion.</p>
          </div>
          <div class="card">
            <h3>Continuous</h3>
            <p>Maps numeric fields through a Viridis gradient and shows a legend with min and max. Filters are disabled in this mode.</p>
          </div>
          <div class="card">
            <h3>Gene</h3>
            <p>Loads gene vectors from CSC expression data. Requires export with <code>--include-expr</code>.</p>
          </div>
        </div>
        <div class="note">
          Filtering is disabled for categorical fields with more than 5000 categories to prevent excessive UI and memory usage.
        </div>
      </section>

      <section id="grid">
        <h2>Sample grid layout</h2>
        <p>Sample grid mode repositions points to display sample groups in a tiled grid. It uses the selected categorical obs field and optional filter state.</p>
        <ul>
          <li>Centers each category by its bounding box in the active spatial space.</li>
          <li>Tiles categories into a grid based on count.</li>
          <li>Applies padding for spacing between tiles.</li>
        </ul>
        <div class="shot" data-label="Screenshot placeholder: grid layout of samples"></div>
      </section>

      <section id="export">
        <h2>Screenshots, recording, export</h2>
        <div class="split">
          <div>
            <h3>Screenshot</h3>
            <p>Captures the viewport only and writes a PNG into the output directory.</p>
            <h3>Recording</h3>
            <p>Writes frame PNGs for each frame while recording. Use ffmpeg to assemble a video if desired.</p>
            <pre><code>ffmpeg -framerate 30 -i frames/frame_%06d.png -c:v libx264 -pix_fmt yuv420p out.mp4</code></pre>
            <h3>Export loop</h3>
            <p>Creates a fixed number of frames for one full loop based on speed and playback mode. Optionally runs ffmpeg if available.</p>
          </div>
          <div class="shot" data-label="Screenshot placeholder: export status panel"></div>
        </div>
      </section>

      <section id="performance">
        <h2>Performance tuning</h2>
        <ul>
          <li>Use <strong>Max draw</strong> to cap the number of rendered points.</li>
          <li>Enable <strong>Fast render</strong> to draw square sprites without circle masking.</li>
          <li>Enable <strong>Opaque points</strong> to avoid alpha blending overhead.</li>
          <li>Shuffle draw order to reduce visible stratification when downsampling.</li>
          <li>Export runs frame by frame, so larger datasets can require more time and disk space.</li>
        </ul>
      </section>

      <section id="troubleshooting">
        <h2>Troubleshooting</h2>
        <div class="grid">
          <div class="card">
            <h3>Python exporter errors</h3>
            <p>Make sure <code>anndata</code>, <code>h5py</code>, <code>numpy</code>, <code>pandas</code>, and <code>scipy</code> are installed. The viewer can auto-detect Python from virtual environments or PATH.</p>
          </div>
          <div class="card">
            <h3>No spaces detected</h3>
            <p>Ensure there is at least one 2D space in <code>adata.obsm</code> or a pair of obs columns named like <code>x/y</code> or <code>spatial_x/spatial_y</code>.</p>
          </div>
          <div class="card">
            <h3>Large categories</h3>
            <p>Filtering is disabled when categorical fields exceed 5000 categories. Export a smaller field or subset categories.</p>
          </div>
          <div class="card">
            <h3>Blank view</h3>
            <p>Check that the .stviz file is valid and that spaces contain finite coordinates. Use "Fit view" to recenter.</p>
          </div>
        </div>
      </section>

      <section id="extend">
        <h2>Extending stviz</h2>
        <div class="split">
          <div>
            <h3>UI and behavior</h3>
            <p>Update <code>src/app.rs</code> to add new UI controls or playback behavior. The UI writes render parameters into a shared struct for the GPU callback.</p>
            <h3>Rendering pipeline</h3>
            <p>Modify <code>src/render.rs</code> and <code>assets/pointcloud.wgsl</code> to add new render effects, point shapes, or uniforms.</p>
          </div>
          <div>
            <h3>File format and exporter</h3>
            <p>Update <code>python/export_stviz.py</code> and <code>src/data.rs</code> together when changing the schema. Keep alignment and offset rules consistent.</p>
            <h3>New input types</h3>
            <p>Add pre-processing scripts in <code>python/</code> to convert from other formats into .h5ad, then reuse the exporter.</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="wrap">
      stviz documentation generated for this repository. Update this file when the data format or UI changes.
    </div>
  </footer>
</body>
</html>
